\chapter{Simulación}

La simulación es un proceso que nos permite estudiar el comportamiento de un sistema complejo y difícil de examinar de manera analítica. Nos ayuda a determinar de manera empírica las probabilidades de ciertos eventos. También nos permite experimentar con diversos supuestos que podrían ser muy costosos o riesgosos de realizar físicamente, como enseñar a los pilotos a volar un avión.

Algunas áreas de aplicación son: biología, estadística, medicina, química, matemáticas, investigación de operaciones, física, ingeniería y ciencias sociales. Los ejemplos de su aplicación van desde simular el lanzamiento de una moneda justa, hasta la simulación de colisiones de átomos en un acelerador de partículas.

Actualmente se combinan diferentes metodologías de simulación con el software disponible, el análisis de sensibilidad y la optimización estocástica. Ésto para obtener un mejor resultado al momento de simular sistemas que son cada vez más complejos como las redes neuronales.

En este trabajo utilizamos la simulación para poder realizar predicciones en base a datos históricos. Tomamos la información de los horarios de la Facultad y con ellos simulamos la demanda del número de alumnos para el siguiente semestre. Con esta demanda hicimos los esqueletos necesarios para realizar la asignación de horarios.

En \textit{R} realizamos la función \textit{gen\_asignacion} encargada de generar la asignación de horarios, materias y profesores. En la \figurename{~\ref{DF_genAsig}} se muestra el diagrama de flujo que sigue dicha función. A lo largo de este capítulo explicaremos los pasos (3)-(9) mostrados en el diagrama. Cabe aclarar que los pasos (1) y (2) corresponden a las Secciones \ref{sec_ED_SelectorGadget} y \ref{sec_ED_LimpiezaDatos}, respectivamente.

\begin{figure}[H]
\centering
\includegraphics[width=\textwidth]{diagrama_flujo} %scale = 0.7
\caption[\textit{Diagrama de flujo de la función \textbf{gen\_asignacion}}]{\textit{Diagrama de flujo de la función \textbf{gen\_asignacion}: Muestra el proceso que se sigue para la obtención de la matriz de asignación de horario.}}\label{DF_genAsig}
\end{figure}


\input{Sim_nom_materias} %%Sección %%To include subfiles in to a subfiles use \input{name_of_file}

\input{Sim_obtencionq1q2} %%Sección %%To include subfiles in to a subfiles use \input{name_of_file}

\input{Sim_demanda_alumnos} %%Sección %%To include subfiles in to a subfiles use \input{name_of_file}

\section{Simulación de tamaño de grupos} \label{SimTamGpos}

En esta sección vamos a explicar cómo hicimos la simulación del tamaño de grupos. Vamos a definir al tamaño de un grupo como el número de alumnos que va a tener cada grupo.

Hicimos una función en \textit{R} que realiza los siguientes pasos:
  
  \begin{enumerate}
\item Definir \textit{m\_grande\_2015} la cual es una submatriz de \textit{m\_grande\_total} con los datos de los semestres del 2015-1 al 2020-1.

\item Obtener, de \textit{m\_grande\_2015}, la información del número de alumnos que ha tenido un profesor.

\item Tomar el mínimo $(a)$ y el máximo $(b)$ de esos datos.

\item Generar un número aleatorio con distribución uniforme en ese intervalo con la función \verb@runif(1,min = a, max = b)@ en \textit{R}.

\item Redondear el número aleatorio con la función \verb@ceiling()@ en \textit{R}.

\item Regresar el número redondeado.
\end{enumerate}

Con este procedimiento simulamos el tamaño de los grupos con respecto a los profesores. En la vida real cuando un alumno decide inscribirse a una materia a cierta hora, la decisión que toma para elegir el grupo al que se quiere inscribir es el profesor con el que le gustaría tomar esa materia a esa hora. Decidimos realizar de esta manera la simulación porque queremos que el número de alumnos de cada grupo dependa de los profesores y no de la distribución general que tiene el tamaño de los grupos (ver Sección \ref{DitribTamGpos}).

\input{Sim_nom_profesores} %%Sección %%To include subfiles in to a subfiles use \input{name_of_file}

\input{Sim_solicitudes} %%Sección %%To include subfiles in to a subfiles use \input{name_of_file}

\input{Sim_gmm} %%Sección %%To include subfiles in to a subfiles use \input{name_of_file}

\section{Simulación de esqueletos}

%En esta sección vamos a explicar cómo generamos la matriz \textit{mat\_esqueleto}, utilizando el Modelo de Mezcla Gaussiana visto en la sección \ref{sec_GMM}. La matriz tiene $t$ renglones y $m$ columnas. En la entrada $(i,j)$ se tiene el número de grupos simulados para la hora $i$ y la materia $j$. La matriz \textit{mat\_esqueleto} depende de la demanda de alumnos y de las solicitudes de los profesores.

En esta sección vamos a explicar cómo generamos la matriz \textit{mat\_esqueleto}. La matriz tiene $t$ renglones y $m$ columnas. En la entrada $(i,j)$ se tiene el número de grupos simulados para la hora $i$ y la materia $j$. La matriz \textit{mat\_esqueleto} depende de la demanda de alumnos y de las solicitudes de los profesores.


El proceso que seguimos para obtener la matriz \textit{mat\_esqueleto} es el siguiente:
  
  \begin{enumerate}
\item Obtener la matriz \textit{mat\_demanda\_alumnos} con la demanda simulada del número de alumnos para el siguiente semestre (ver Sección \ref{GMM_D}).

\item Obtener la matriz \textit{mat\_solicitudes} con las solicitudes simuladas de los profesores (ver Sección \ref{SimSolicitudesProfesores}).

\item Elegir un profesor de tiempo completo al azar.

\item Elegir al azar un horario y una materia que haya solicitado el profesor elegido en el paso anterior. Con estos datos obtenemos las coordenadas $(i,j)$ para las matrices \textit{mat\_demanda\_alumnos} y \textit{mat\_esqueleto}.

\item Verificar que a esa materia en esa hora aún le sobran alumnos, en la entrada $(i,j)$ de \textit{mat\_demanda\_alumnos}.

\item Simular el número de alumnos para ese grupo (ver Sección \ref{SimTamGpos}).

\item Restar el número de alumnos simulados en el paso anterior, de la materia y hora elegidas, en la entrada $(i,j)$ de \textit{mat\_demanda\_alumnos}.

\item Ese profesor ya no puede impartir clases a esa hora. Retirar renglones correspondientes de \textit{mat\_solicitudes}.

\item Repetir los pasos de 3 a 8 hasta que se terminen los profesores.

\item Una vez que se terminen los profesores de tiempo completo, hacer los pasos de 3 a 9 con los profesores de asignatura.
\end{enumerate}

Algunas notas a considerar del procedimiento son:
  
  \begin{itemize}
%\item[-] Se le da prioridad de asignación a los profesores de tiempo completo.

\item[-] Los profesores de tiempo completo deben cumplir con sus horas, por contrato.

\item[-] Los profesores sólo pueden tener asignadas a lo más 2 materias.

\item[-] Las condiciones de paro del proceso son:
  
  \begin{itemize}
\item[a)] Ya se cubrió toda la demanda

\item[b)] Ya no hay más profesores

\item[c)] Llegar a una cota predefinida para que el ciclo no se haga infinito o tarde mucho en cumplir las condiciones anteriores.
\end{itemize}
\end{itemize}

En la \figurename{~\ref{esqueleto20202}} vemos un ejemplo de la matriz \textit{mat\_esqueleto} para el semestre 2020-2. Observemos las últimas 4 columnas que corresponden a las materias de \textit{Cálculo Diferencial e Integral I, II, III} y \textit{IV}. Notamos que el número de grupos simulados para las materias de semestres pares \textit{(Cálculo Diferencial e Integral II y IV)} es mayor que para las materias de semestres impares \textit{(Cálculo Diferencial e Integral I y III)}. Esto se debe al comportamiento descrito en la Sección \ref{AE_x_GpoDeDatos} y el semestre 2020-2 es par.

\begin{figure}[H]
\centering
\includegraphics[width=\textwidth]{Ej_esqueleto_20202} %scale = 0.7
\caption[\textit{Ejemplo de esqueleto para el semestre 2020-2}]{\textit{Ejemplo de esqueleto para el semestre 2020-2: En la entrada (i,j) podemos observar el número de alumnos simulados para la hora i y la materia j.}}\label{esqueleto20202}
\end{figure}

%\subsection{Calificación de esqueletos de horario}
%\subsection{Calificación de D}
%
%Se califica por materia y por grupo



%\textbf{NOTAS:}
%
%\begin{itemize}
%\item[-] Sólo estamos haciendo operaciones cuando las entradas de \textit{bin\_DUE} haya un 1.\\
%
%\item[-] La diferencia relativa la definimos como $\dfrac{D - E}{D}$ porque la demanda es lo que esperamos que ocurra.
%\end{itemize}
%
%En la \figurename{~\ref{dif_D_E_gpo}} vemos el histograma de la diferencia de las matrices D - E. Diferencia entre el número de alumnos esperados menos el número de alumnos simulados por grupo. Los valores se encuentran entre -166 y 432.
%
%\begin{figure}[H]
%\centering
%\includegraphics[scale = 0.5]{histograma_FR_D-E_x_gpo} %width=\textwidth
%\caption{\textit{Histograma de la diferencia de las matrices D - E por grupo}}\label{dif_D_E_gpo}
%\end{figure}
%
%
%En la \figurename{~\ref{difRel_D_E_gpo}} vemos el histograma de la diferencia relativa de las matrices D y E. Diferencia entre el número de alumnos esperados menos el número de alumnos simulados, entre el número de alumnos esperados, por grupo. Los valores se encuentran entre -71 y 1.
%
%El valor de -71 corresponde a la materia \textit{Teoría de los Conjuntos I}. A las 14hrs, en la matriz D vale 1 y en la matriz E vale 72 entonces el error relativo es -71.
%
%El valor de -64 corresponde a la materia \textit{Inferencia Estadística}. A las 12hrs, en la matriz D vale 1 y en la matriz E vale 65 entonces el error relativo es -64.
%
%El valor de -61 corresponde a la materia \textit{Probabilidad II}. A las 11hrs, en la matriz D vale 1 y en la matriz E vale 62 entonces el error relativo es -61.
%
%El valor de -61 corresponde a la materia \textit{Historia de las Matemáticas I}. A las 13hrs, en la matriz D vale 1 y en la matriz E vale 62 entonces el error relativo es -61.
%
%El valor de -50 corresponde a la materia \textit{Demografía}. A las 17hrs, en la matriz D vale 1 y en la matriz E vale 51 entonces el error relativo es -50.
%
%El valor de 1 corresponde a 111 materias, veamos 5 casos: \textit{Álgebra Moderna I (8hrs), Álgebra Lineal II (8hrs), Análisis Matemático II (16hrs), Manejo de Datos (16hrs), Seminario sobre enseñanza de las Matemáticas I (17hrs)}. En la matriz D valen 6, 16, 21, 3 y 7 respectivamente. En la matriz E valen 0, entonces el error relativo es 1.
%
%\begin{figure}[H]
%\centering
%\includegraphics[scale = 0.5]{histograma_FR_D-E_D_x_gpo} %width=\textwidth
%\caption{\textit{Histograma de la diferencia relativa de las matrices D y E por grupo}}\label{difRel_D_E_gpo}
%\end{figure}


%En la \figurename{~\ref{dif_D_E_materia}} vemos el histograma de la diferencia de las matrices D - E. Diferencia entre el número de alumnos esperados menos el número de alumnos simulados por materia. Los valores se encuentran entre -259 y 244.
%
%\begin{figure}[H]
%\centering
%\includegraphics[scale = 0.4]{histograma_FR_D-E_x_materia} %width=\textwidth
%\caption{\textit{Histograma de la diferencia de las matrices D - E por materia}}\label{dif_D_E_materia}
%\end{figure}

%
%En la \figurename{~\ref{difRel_D_E_materia}} vemos el histograma de la diferencia relativa de las matrices D y E. Diferencia entre el número de alumnos esperados menos el número de alumnos simulados, entre el número de alumnos esperados, por grupo. Los valores se encuentran entre -97 y 6.
%
%\begin{figure}[H]
%\centering
%\includegraphics[scale = 0.4]{histograma_FR_D-E_D_x_materia} %width=\textwidth
%\caption{\textit{Histograma de la diferencia relativa de las matrices D y E por materia}}\label{difRel_D_E_materia}
%\end{figure}
%
%En la siguiente figura vemos las 20 materias con error relativo más negativo:
%
%\begin{figure}[H]
%\centering
%\includegraphics[scale = 1]{error_relativo_20materias_negativo} %width=\textwidth
%\caption{\textit{error relativo 40materias}}
%\end{figure}
%
%En la siguiente figura se tienen los valores en D y E de los 5 casos más negativos:
%
%\begin{figure}[H]
%\centering
%\includegraphics[scale = 0.85]{D_E_5_negativos} %width=\textwidth
%\caption{\textit{Casos más negativos}}
%\end{figure}
%
%
%En la siguiente figura vemos las 20 materias con error relativo más positivo:
%
%\begin{figure}[H]
%\centering
%\includegraphics[scale = 1]{error_relativo_20materias_positivo} %width=\textwidth
%\caption{\textit{error relativo 40materias}}
%\end{figure}
%
%En la siguiente figura se tienen los valores en D y E de los 5 casos más positivos:
%
%\begin{figure}[H]
%\centering
%\includegraphics[scale = 0.9]{D_E_5_positivos} %width=\textwidth
%\caption{\textit{Casos más positivos}}
%\end{figure}
%
%
%\begin{eqnarray*}
%L_{materia} &=& -1 \,\,\,\,\,\,  \text{por cada materia no impartida}\\
%x &=& \text{promedio}\\
%y &=& \text{cupo}\\
%L_{dif\_p\_c} (x,y) &=& \begin{cases}
%\dfrac{a}{190} (x-y)  & \quad \text{si } x<y\\
%- \dfrac{b}{190} (x-y)  & \quad \text{si } x\geqslant y
%\end{cases}\\
%a &=& 0.5\\
%b &=& 0.8\\
%L_{categoria}^{1} (mat,solicitud) &=& -c(categoria - 1)\\
%L_{categoria}^{2} (mat,solicitud) &=& -c_{1}(categoria)
%\end{eqnarray*}
%
%Al momento de simular las solicitudes de materias para los profesores suponemos que la que está en primer lugar es la materia que más quiere dar, en segundo lugar, la segunda que quiere dar.
%
%Primero asignar grupos a los profesores de tiempo completo. Después asignar grupos faltantes a los profesores de asignatura.
%
%$L_{materia}$ es la penalización por no tener en el esqueleto una materia que necesitamos.
%
%$L_{dif\_p\_c}$ es la penalización en la asignación de salones. Se tiene un grupo de tamaño $x$ y un salón con capacidad $y$. Se penaliza con $\dfrac{a}{190}$ veces la diferencia entre $x$ y $y$ cuando el tamaño del grupo es menor a la capacidad del salón y se penaliza con $-\dfrac{b}{190}$ veces la diferencia entre $x$ y $y$ cuando el tamaño del grupo es mayor a la capacidad del salón.
%
%El esqueleto depende de la demanda de alumnos y de las solicitudes de los profesores.
%
%Primero se asignan materias a los profesores de tiempo completo y después a los de asignatura.
%
%Los profesores de asignatura pueden quedarse sin materias asignadas.
%
%Penalizaciones:
%  
%  \begin{enumerate}
%\item Si algún profesor pidió alguna materia y no se la dieron.
%
%\item Si hay alumnos que necesitan una clase a alguna hora y no existe profesor que la imparta.
%
%\item Con $\alpha \times num\_alumnos\_faltantes$ por cada alumno que te faltó en cada hora-materia que tenías que dar. $\alpha > 0$
%  
%  \item Con $\beta \times num\_alumnos\_sobrantes$ por cada alumno que te pasaste en cada hora-materia que tenías que dar. $\beta > 0$
%  
%  \end{enumerate}
%
%%Queremos el esqueleto con el menor valor en $\alpha + \beta$
%  
%  Con esto se califica un esqueleto.

